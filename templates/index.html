<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Budget2</title>
<script>
function getPaymentTypes() {

	// Create new request object:
	var reqPaymentTypes = new XMLHttpRequest();
	reqPaymentTypes.open("GET", "/ajax/payment_types");

	// Define event listener:
	reqPaymentTypes.onreadystatechange = function() {

		// Check if the request completed and was successful:
		if (this.readyState == 4 && this.status == 200) {

			// Parse the returned data and find our select object:
			var data = JSON.parse(this.responseText);
			var selectPaymentTypes = document.getElementById("selectPaymentTypes")

			// Foreach element returned in the JSON,
			// dynamically create our option object:
			data.forEach( function(obj) {
				var option = document.createElement("option");
				option.value = obj.id;
				option.text = obj.name;
				selectPaymentTypes.add(option);
			});
		}
	};
	// Fire off the request:
	reqPaymentTypes.send();
}

function getPaymentHistory() {

	// Create new request object:
	var reqPaymentHistory = new XMLHttpRequest();
	reqPaymentHistory.open("GET", "/ajax/payments");

	// Define event listener:
	reqPaymentHistory.onreadystatechange = function() {

		// Check if the request completed and was successful:
		if (this.readyState == 4 && this.status == 200) {

			// Parse the returned data and find our select object:
			var data = JSON.parse(this.responseText);
			var ulPaymentHistory = document.getElementById("ulPaymentHistory")

			// Clean our Li before re-adding children:
			while (ulPaymentHistory.firstChild) {
				ulPaymentHistory.removeChild(ulPaymentHistory.firstChild);
			}

			// Foreach element returned in the JSON,
			// dynamically create our option object:
			data.forEach( function(obj) {
				var li = document.createElement("li");
				li.innerHTML = JSON.stringify(obj, null, 2);
				ulPaymentHistory.appendChild(li);
			});
		}
	};
	// Fire off the request:
	reqPaymentHistory.send();
}

function getPaymentSums() {

	// Create new request object:
	var reqPaymentSums = new XMLHttpRequest();
	reqPaymentSums.open("GET", "/ajax/paymentsummary");

	// Define event listener:
	reqPaymentSums.onreadystatechange = function() {

		// Check if the request completed and was successful:
		if (this.readyState == 4 && this.status == 200) {

			// Parse the returned data and find our select object:
			var data = JSON.parse(this.responseText);
			var ulPaymentSummary = document.getElementById("ulPaymentSummary")

			// Clean our Li before re-adding children:
			while (ulPaymentSummary.firstChild) {
				ulPaymentSummary.removeChild(ulPaymentSummary.firstChild);
			}

			// Foreach element returned in the JSON,
			// dynamically create our option object:
			data.forEach( function(obj) {
				var li = document.createElement("li");
				li.innerHTML = JSON.stringify(obj, null, 2);
				ulPaymentSummary.appendChild(li);
			});
		}
	};
	// Fire off the request:
	reqPaymentSums.send();
}

function getMonthlySums() {

	// Create new request object:
	var reqMonthlySums = new XMLHttpRequest();
	reqMonthlySums.open("GET", "/ajax/monthlysummary");

	// Define event listener:
	reqMonthlySums.onreadystatechange = function() {

		// Check if the request completed and was successful:
		if (this.readyState == 4 && this.status == 200) {

			// Parse the returned data and find our select object:
			var data = JSON.parse(this.responseText);
			var ulMonthlySummary = document.getElementById("ulMonthlySummary")

			// Clean our Li before re-adding children:
			while (ulMonthlySummary.firstChild) {
				ulMonthlySummary.removeChild(ulMonthlySummary.firstChild);
			}

			// Foreach element returned in the JSON,
			// dynamically create our option object:
			data.forEach( function(obj) {
				var li = document.createElement("li");
				li.innerHTML = JSON.stringify(obj, null, 2);
				ulMonthlySummary.appendChild(li);
			});
		}
	};
	// Fire off the request:
	reqMonthlySums.send();
}

// Submit payment to server
function submitPayment() {

	var selectPaymentTypes = document.getElementById("selectPaymentTypes");
	var paymentType = selectPaymentTypes.options[selectPaymentTypes.selectedIndex];
	var payment_type_id = parseInt(paymentType.value);

	var amount = parseFloat(document.getElementById("inputPayment").value);
	if (amount == 0) {
		alert("Please entire an amount to pay");
		return;
	}
	var paymentJSON = {
		"payment_type_id": 	payment_type_id,
		"amount":			amount
	}

	// Create new request object:
	var reqAddPayment = new XMLHttpRequest();
	reqAddPayment.open("POST", "/ajax/payments");
	reqAddPayment.setRequestHeader("Content-type", "application/json");
	reqAddPayment.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			// Refresh current display:
			getPaymentHistory();
			getMonthlySums();
		}
	};

	// Fire off the request:
	reqAddPayment.send(JSON.stringify(paymentJSON));
}

// Function loaded when body is ready:
function loadBodyAjax() {
	getPaymentTypes();
	getPaymentSums();
	getPaymentHistory();
	getMonthlySums();
}
</script>
</head>
<body onload="loadBodyAjax()">
	<h2>budget2</h2>
	<div name="divPayment">
	  <b>$</b>
	  <input type="text" id="inputPayment">
	  <select id="selectPaymentTypes">
	  </select>
	  <button id="buttonSubmitPayment" onclick="submitPayment()">Pay</button>
	</div>
	<h4>payment summary</h4>
	<div name="divPaymentSummary">
		<ul id="ulPaymentSummary">
		</ul>
	</div>
	<h4>payment history</h4>
    <div name="divPaymentHistory">
      <ul id="ulPaymentHistory">
      </ul>
    </div>
	<h4>monthly sums</h4>
    <div name="divMonthlySummary">
      <ul id="ulMonthlySummary">
      </ul>
    </div>
</body>
</html>
